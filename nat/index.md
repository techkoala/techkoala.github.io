# NAT系列1：认识NAT


    一文概览NAT

<!--more-->

## NAT

NAT（Network Address Translation，网络地址转换）在计算机网络中是一种在IP数据包通过路由器或防火墙时重写来源IP地址或目的IP地址的技术。这种技术被普遍使用在有多台主机但只通过一个公有IP地址访问互联网的私有网络中。

NAT从大类上都可以分为两类：`静态NAT`和`动态NAT`。

`静态NAT`是管理员手动创建和维护映射，通常与NAT的入站类型相关联。

`动态NAT`是路由器根据需要自动创建和维护映射，通常与NAT的出站类型相关联。

每个TCP/IP数据包都包含一个`源IP地址`、`源端口`、`目的IP地址`和`目的端口`。所有类型的NAT都会使用这些值创建NAT映射。

    例如，一个IP为`192.168.0.1`的内部客户机使用端口`56876`，经过NAT转变后IP变
    为3.3.3.3（翻译后的源IP）和端口56876（源端口）连接到IP 2.2.2.2（目的IP地
    址）的80端口（目的端口）。NAT使用原始内部IP和端口、翻译后IP和端口这4个值创建
    一个映射。当数据包从网站返回到路由器时，使用与该映射相关值，NAT将数据包转发到
    内部客户端。

## NAT的四种类型

### 全锥型NAT（Full Cone NAT)

{{< image src="/images/Network/NAT/Full_Cone_NAT.png" caption="全锥型NAT" >}}

全锥型NAT是静态NAT，也是唯一一种永久开放端口的NAT，允许从**任何外部主机**进行入站连接。全锥型NAT将一个公共IP地址和端口映射到LAN IP和端口。任何外部主机都可以通过映射的NAT IP和端口向LAN IP发送数据。但是，如果它试图通过不同的端口发送数据，就会失败。这种类型的NAT也被称为端口转发。这是受限制最少的NAT类型，唯一的要求是连接在一个特定的端口（客户端打开的端口）。

    例如，我的电脑有一个网站在80端口上运行，我创建了一个一对一的规则，将路由器的
    WAN IP 1.1.1.1映射到192.168.0.1，端口80映射到80端口。凡是在80端口向
    1.1.1.1发送数据的外部主机都会被NAT转发到192.168.0.1 80端口。

**注意**：端口号不必相同；我可以在56456端口上运行我的网站，但创建NAT映射，将80端口转发到56456端口。这样，外部客户端就会认为我的网站在80端口上，而在任何其他端口上的连接尝试都会被丢弃。

### 受限锥形NAT（Restricted Cone NAT）

{{< image src="/images/Network/NAT/Restricted_Cone_NAT.png" caption="受限锥形NAT" >}}

受限锥体NAT是动态NAT，它的工作方式与全锥型NAT相同，但会对进站的IP地址施加额外的限制。根据限制，唯一的要求是数据包必须从映射的端口进入，并且来自内部客户端已发送数据包的IP地址。**亦即需要内部主机首先发起连接的外部主机，才能被接受入站。**

    例如，我的电脑与一个网站(56.45.34.78)进行外向连接，源IP为192.168.0.1，源端
    口为56723。NAT使用源端口56723创建一个（动态）映射到我的电脑。使用目的端口
    56723（这是出站NAT的源端口）到达的源IP为56.45.34.78（网站IP）的数据包将被接
    受，接着网站返回数据至我的PC。任何其他IP即使使用正确的56723端口进行连接尝试将
    被丢弃。同样，即使正确的IP使用56723以外的目的端口进行的连接尝试也将被丢弃。

### 端口受限锥型NAT（Port Restricted Cone NAT)

{{< image src="/images/Network/NAT/Port_Restricted_Cone_NAT.png" caption="端口受限锥型NAT" >}}

端口受限锥型NAT是动态NAT，它的作用与受限锥形NAT完全相同，但同时对端口进行限制。受限锥形NAT接受来自外部主机任何源端口的连接，而端口受限锥型NAT则进一步要求外部主机的源端口是固定的。

    例如，我的电脑在80端口（目标端口）上向网站IP 217.87.69.8建立了一个外向连接。
    NAT将我的源IP 192.168.0.1映射到WAN IP 1.1.1.1和源端口56723。当网站发回
    数据包时，它的源IP必须是217.87.69.8，目的端口是56723（就像一个受限锥型NAT），
    但除此之外，还要求源端口必须是80。如果这三者中的任何一个不一样，端口受限锥型NAT
    就会放弃连接。

### 对称型NAT（Symmetric NAT）

{{< image src="/images/Network/NAT/Symmetric_NAT.png" caption="对称型NAT" >}}

对称型NAT是动态NAT，它限制的方式与端口受限锥型NAT完全相同，但处理NAT转换的方式不同。目前讨论的所有类型的NAT在NAT连接时都**不会改变源端口**。

    例如，当客户端使用IP 192.168.0.1和源端口56723访问互联网时，NAT将源IP改变为
    56.35.67.35，但保持端口号不变，这被称为端口保留。

而对称型NAT会将端口改为**随机生成的新端口**，甚至是同一客户端到不同目的地的连接也会发生。**亦即为每个连接创建唯一的映射**

    例如，在端口受限锥型NAT的例子上进行扩展，我的PC向网站IP 217.87.69.8和
    56.76.87.98建立两个出站连接。我的电脑使用源IP 192.168.0.1和源端口56723进行
    两个连接。到目前为止，在所有类型的NAT上，这两个连接都会被NAT化，只改变源IP地址
    而保持源端口不变。然而这次，对称型NAT没有将源端口保留为56723，而是将其中一个连
    接的源端口改为45765，另一个连接的源端口改为53132（随机）。这就为每个连接创建了
    唯一的映射，来自这些目的地的流量必须通过各自的端口进入。所以217.87.69.8必须将
    数据包发送到目的端口45765，56.76.87.98必须将数据包发送到端口53132，此外还需
    要遵循端口受限锥型NAT的要求。

## 对NAT的正面评价

1. NAT在一定程度上缓解了IPv4地址短缺的问题，让更多的设备（间接）接入了互联网。

2. NAT全双工连接支持的缺少在一些情况下可以看作是一个有好处的特征而不是一个限制。在一定程度上，NAT依赖于本地网络上的一台机器来初始化和路由器另一边的主机的任何连接，它可以阻止外部网络上的主机的恶意活动。这样就可以阻止网络蠕虫病毒来提高本地系统的可靠性，阻挡恶意浏览来提高本地系统的私密性。很多具有NAT功能的防火墙都是使用这种功能来提供核心保护的。另外，它也为UDP的跨局域网的传输提供了方便。

## 对NAT的批评

1. 在一个具有NAT功能的路由器下的主机并没有获得真正的IP地址，并且不能参与一些因特网协议，一些需要初始化从外部网络创建的TCP连接和无状态协议（比如UDP）无法实现。除非NAT路由器管理者预先设置了规则，否则送来的数据包将不能到达正确的目的地址。

2. 端对端连接是被IAB委员会（Internet Architecture Board）支持的核心因特网协议之一，因此有些人据此认为NAT是对公用因特网的一个破坏。一些因特网服务提供商（ISP）只向他们的客户提供本地IP地址，所以他们必须通过NAT来访问ISP网络以外的服务，并且这些公司能不能算的上真正的提供了因特网服务的话题也被谈起。

## 参考

- [1] [网络地址转换](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2)

- [2] [What you need to know about symmetric NAT](https://think-like-a-computer.com/2011/09/19/symmetric-nat/)

- [3] [NAT Types Defined](https://portforward.com/nat-types/)
